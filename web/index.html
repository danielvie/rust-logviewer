<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>LogViewer</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
        crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
        integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI="
        crossorigin="anonymous"></script>
        
    <style>
        .menu-container {
            display: grid;
            align-content: center;
            justify-content: center;
            position: fixed;
            top: 0;
            /* left: 50%;
            transform: translate(-50%, 0); */
            width: 100%;
            background-color: #f0f0f0;
            padding: 10px 0;
        }
        .table {
            margin-top: 50px;
        }
        /* .menu-main {
        } */
    </style>

</head>

<body>
    <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

    <div class="menu-container">
        <div class="menu-main">
            <select id="selectLog" name: "selectLog">
                <option name="0" value="none" selected="selected">Select log</option>
            </select>

            <select id="filterLog" name: "filterLog">
                <option name="0" value="none" selected="selected">No filter</option>
                <option name="1" value="info">INFO</option>
                <option name="2" value="warn">WARN</option>
                <option name="3" value="error">ERROR</option>
                <option name="4" value="warnerror">WARN+ERROR</option>
                <option name="5" value="debug">DEBUG</option>
                <option name="6" value="other">OTHER</option>
            </select>
            
            <input type="text" id="input-regex" placeholder="regex filter" value="OnAxiniConnected"/>
            
            <button id="btn-load">Load</button>
            <button id="btn-auto-refresh">auto-refresh...</button>

            <div style="display: inline-block">
                <input id="check-last" type="checkbox" />
                <label>only-last</label>
            </div>
        </div>
    </div>

    <table id="logs" class="table">
        <thead>
            <tr>
                <th scope="col">Line #</td>
                <th scope="col">Type</td>
                <th scope="col">Text</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>




    <script type="text/javascript">
        var DATA = [{
            filename: "Log001.log",
            log_entries: [{
                line: 1,
                entry: { Info: "INFO: If you see this" }
            },
            {
                line: 2,
                entry: { Error: "ERROR: This has been an error loading the log files" }
            }
            ]
        },
        {
            filename: "Log002.log",
            log_entries: [{
                line: 1,
                entry: { Info: "INFO: Try again once more" }

            },
            {
                line: 2,
                entry: { Error: "ERROR: and take a look at the log output in the console" }
            },
            {
                line: 3,
                entry: { Debug: "DEBUG: If you encounter the same problem again" }
            },
            {
                line: 4,
                entry: { Warn: "WARN: try running the program from a different folder" }
            },
            {
                line: 5,
                entry: { Other: "OTHER: or create an issue at https://github.com/cfsamson/rust-logviewer" }
            }
            ]
        }
        ];

        let _file = document.getElementById('selectLog')
        let _filter = document.getElementById('filterLog')
        let _nstart = 0

        function gotoNextStart(n) {
            let s = document.getElementsByClassName('table-success')

            // condition for (-2) == last
            _nstart = n
            if (_nstart === -2) {
                _nstart = s.length - 1
            }
            
            // limiting the values of _nstart: [0, length - 1]
            _nstart = Math.min(Math.max(_nstart, 0), s.length - 1)
            
            let el = s[_nstart]
            // el.scrollIntoView()

            let position = el.getBoundingClientRect()
            window.scrollTo(position.left, position.top + window.scrollY - 50)
            
            console.log(`going to ${_nstart+1} / ${s.length + 1}`)
        }
        
        document.addEventListener('keyup', (e) => {
            console.log(e)
            console.log(e.code)

            if (e.code == 'r') {
                console.log('refresh...')
                refreshData()
            }
            
            if (e.code == 'Equal') {
                gotoNextStart(_nstart + 1)
            }

            if (e.code == 'Minus') {
                gotoNextStart(_nstart -1)
            }

            if (e.code == 'BracketRight') {
                gotoNextStart(-2)
            }

            if (e.code == 'BracketLeft') {
                gotoNextStart(0)
            }
        })

        async function wait(ms) {
                return new Promise(resolve => {
                    setTimeout(resolve, ms);
                });
            }

        
        async function loadData() {

            console.log('load data...')

            let response = await fetch("/logs");
            let data = await response.json();
            
            // saving filter value
            let filter_value = _filter.value

            if (data.response === "ok") {
                DATA = data.data;
            } else {
                console.log(`ERROR: ${data.message}`);
            }

            // when data is loaded
            dataLoaded();
            // filterLog_()


            // _filter.value = filter_value

            // filterLog_()
            let filterSelect = document.getElementById("filterLog");
            filterSelect.onchange = filterLog;
        }
        
        document.getElementById('btn-load').addEventListener('click', (e) => {
            refreshData()
        })

        let flag_timeout = false
        document.getElementById('btn-auto-refresh').addEventListener('click', (e) => {
            // getLog_()
            // loadData()
            flag_timeout = !flag_timeout
            updateRefreshBtn()
            refreshDataTimeout(1000)
        })

        function updateRefreshBtn() {
            let refr = document.getElementById('btn-auto-refresh')
            refr.innerHTML = (flag_timeout) ? 'Refresh ON' : 'Refresh OFF'
        }

        
        function refreshData() {
            loadData()
            getLog_()
        }

        function refreshDataTimeout(time_ms) {


            if (flag_timeout) {
                setTimeout(() => {
                    console.log('refresh timeout')
                    refreshData()
                    refreshDataTimeout(time_ms)
                }, time_ms)
            }
        }

        
        // document.getElementById('btn-log1').addEventListener('click', (e) => {
        //     window.location.href = "/log/2"
        // })
        
        function main() {
            let document = window.document;
            updateRefreshBtn()
            loadData()
        }

        window.onload = async function () {
            main()
        }

        function dataLoaded() {
            let files = [...new Set(DATA.map((d) => d.filename))]
            let select = document.getElementById("selectLog")
            let filter = document.getElementById("filterLog")
            
            let log_selected = select.value
            let filter_selected = filter.value

            // remove children
            while (select.children.length) {
                select.removeChild(select.firstChild)
            }

            var i = 1;
            for (f of files) {
                let opt = document.createElement("option");
                opt.name = i;
                opt.value = f;
                let txt = document.createTextNode(f);
                opt.appendChild(txt);
                select.appendChild(opt);
                i++;
            }

            select.value = log_selected
            filter.value = filter_selected

            select.onchange = getLog;
        }

        function getLog_() {
            let select = document.getElementById('selectLog')
            let val = select.value;

            if (val === "none") {
                return;
            }

            let log = DATA.find((n) => n.filename === val);
            filterLog_()

            // drawData(log.log_entries);
            // document.getElementById("filterLog").value = "none";
        }

        function getLog(e) {
            console.log(`Getting logs from: ${e.target.value}`);
            let val = e.target.value;

            if (val === "none") {
                return;
            }

            let log = DATA.find((n) => n.filename === val);
            drawData(log.log_entries);
            // document.getElementById("filterLog").value = "none";
        }

        function filterLog_() {
            let current_file = document.getElementById("selectLog").value;
            if (current_file == "none") {
                return;
            }

            let current_log = DATA.find((n) => n.filename === current_file);
            let currentData = current_log.log_entries;

            let filter = _filter.value;
            // console.log(filter);

            var filteredData;

            switch (filter) {
                case "none":
                    filteredData = currentData;
                    break;
                case "info":
                    filteredData = filterData("INFO", currentData);
                    break;
                case "warn":
                    filteredData = filterData("WARN", currentData);
                    break;
                case "error":
                    filteredData = filterData("ERROR", currentData);
                    break;
                case "debug":
                    filteredData = filterData("DEBUG", currentData);
                    break;
                case "other":
                    filteredData = filterData("OTHER", currentData);
                    break;
                case "warnerror":
                    filteredData = filterData("WARN+ERROR", currentData);
                    break;
                default:
                    throw new Error("Invalid filter option")
            }

            // filter by regex
            let re_ = document.getElementById('input-regex').value 
            let re  = new RegExp(re_)
            
            filteredData = filteredData.filter((d) => {

                let info  = re.test(d.entry.Info)
                let warn  = re.test(d.entry.warn)
                let error = re.test(d.entry.Error)
                let debug = re.test(d.entry.Debug)
                let other = re.test(d.entry.Debug)
                
                return info || warn || error || debug || other
            })
            console.log('estou aqui')
            console.log(re)


            drawData(filteredData)
        }

        function filterLog(e) {
            let current_file = document.getElementById("selectLog").value;
            if (current_file == "none") {
                return;
            }

            let current_log = DATA.find((n) => n.filename === current_file);
            let currentData = current_log.log_entries;

            let filter = e.target.value;
            console.log(filter);

            var filteredData;

            switch (filter) {
                case "none":
                    filteredData = currentData;
                    break;
                case "info":
                    filteredData = filterData("INFO", currentData);
                    break;
                case "warn":
                    filteredData = filterData("WARN", currentData);
                    break;
                case "error":
                    filteredData = filterData("ERROR", currentData);
                    break;
                case "debug":
                    filteredData = filterData("DEBUG", currentData);
                    break;
                case "other":
                    filteredData = filterData("OTHER", currentData);
                    break;
                case "warnerror":
                    filteredData = filterData("WARN+ERROR", currentData);
                    break;
                default:
                    throw new Error("Invalid filter option")
            }
            
            
            drawData(filteredData)
        }

        // Returns the filtered data
        function filterData(filter, c_data) {
            console.log(`filterData: ${filter}`);
            switch (filter) {
                case "INFO":
                    return c_data.filter((n) => {return (n.entry.Info ? true : false) || testIsStarting(n)})
                case "WARN":
                    return c_data.filter((n) => {return (n.entry.Warn ? true : false) || testIsStarting(n)})
                case "ERROR":
                    return c_data.filter((n) => {return (n.entry.Error ? true : false) || testIsStarting(n)})
                case "DEBUG":
                    return c_data.filter((n) => {return (n.entry.Debug ? true : false) || testIsStarting(n)})
                case "OTHER":
                    return c_data.filter((n) => {return (n.entry.Other ? true : false) || testIsStarting(n)})
                case "WARN+ERROR":
                    return c_data.filter((n) => {
                        let is_warn = n.entry.Warn ? true : false;
                        let is_err = n.entry.Error ? true : false;
                        let is_start = testIsStarting(n)
                        return is_warn || is_err || is_start;
                    })
                default:
                    console.log("ERROR: Invalid filter")
                    return []
            }
        }
        
        function testIsStarting(d) {
            info = d.entry.Info
            if (!info) {
                return false
            }
            
            return /BaseAdapter.*Waiting.*start/.test(info)
        }

        function drawData(data) {

            let table = document.getElementById("logs");
            let tbody = table.getElementsByTagName("tbody")[0];
            
            // remove existing elements in the table
            let c_nodescount = tbody.childElementCount;
            for (i = 0; i < c_nodescount; i++) {
                tbody.removeChild(tbody.lastChild);
            }

            // filtering last
            // TODO: checked
            let only_last = document.getElementById('check-last').checked
            // let only_last = document.getElementById('check-last')

            // find last test init
            let filename = _file.value
            let data_ = DATA.filter(d => d.filename.includes(filename))[0].log_entries

            let pos_ = -1
            let pos  = -1
            if (only_last) {
                
                for (d of data_) {
                    let info = d.entry.Info
                    if (testIsStarting(d)) {
                        pos_ = pos
                        pos  = d.line
                    }
                }
            }
            
            data = data.filter(d => d.line >= pos)

            // add new elements
            for (d of data) {
                var row_class = "";
                var str_content = "";
                var type = "";
                if (d.entry.Info) {
                    // highlight waiting for test
                    row_class = (testIsStarting(d)) ? "table-success" : "";
                    
                    str_content = d.entry.Info;
                    type = "INFO";
                } else if (d.entry.Error) {
                    row_class = "table-danger";
                    str_content = d.entry.Error;
                    type = "ERROR";
                } else if (d.entry.Warn) {
                    row_class = "table-warning";
                    str_content = d.entry.Warn;
                    type = "WARN";
                } else if (d.entry.Debug) {
                    row_class = "";
                    str_content = d.entry.Debug;
                    type = "DEBUG";
                } else if (d.entry.Other) {
                    row_class = "";
                    str_content = d.entry.Other;
                    type = "OTHER";
                } else {
                    console.log(`"ERROR: Unspecified type: ${d.entry}`)
                    continue;
                }

                // <tr>
                let tr = document.createElement("tr");
                tr.className = row_class;

                // <td>
                var td = document.createElement("td");
                var td_txt = document.createTextNode(d.line);
                td.appendChild(td_txt);
                tr.appendChild(td);
                // </td>

                // <td>
                var td = document.createElement("td");
                var td_txt = document.createTextNode(type);
                td.appendChild(td_txt);
                tr.appendChild(td);
                // </td>

                // <td>
                var td = document.createElement("td");
                var td_txt = document.createTextNode(str_content);
                td.appendChild(td_txt);
                tr.appendChild(td);
                // </td>

                tbody.appendChild(tr);
                // </td>
            }
        }
    </script>

</body>

</html>